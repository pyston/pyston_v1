language: cpp

compiler:
  - clang
  - gcc

# use travis-ci docker based infrastructure
sudo: false

cache:
  directories:
    - $HOME/.ccache
    - $HOME/llvm-package

addons:
  apt:
    sources:
    - kubuntu-backports
    - llvm-toolchain-precise-3.5
    - ubuntu-toolchain-r-test
    packages:
    - autoconf
    - ccache
    - clang-3.5
    - cmake
    - g++-4.8
    - libgmp3-dev
    - liblzma-dev
    - libncurses5-dev
    - libreadline-dev
    - libsqlite3-dev
    - libtool
    - ninja-build
    - python-dev
    - texlive-extra-utils

before_install:
  - if [ "$CC" = "clang" ]; then export CC="clang-3.5" CXX="clang++-3.5"; fi
  - if [ "$CC" = "gcc" ]; then export CC="gcc-4.8" CXX="g++-4.8"; fi

install:
  - ./tools/travis_get_llvm.sh

  - mkdir -p ~/pyston-build && cd ~/pyston-build
  - if [ -d "$HOME/llvm-install" ]; then cmake -GNinja -DTEST_THREADS=4 -DLLVM_DIR=$HOME/llvm-install/share/llvm/cmake $TRAVIS_BUILD_DIR; fi
  - if [ ! -d "$HOME/llvm-install" ]; then cmake -GNinja -DTEST_THREADS=4 $TRAVIS_BUILD_DIR; fi
  - ninja libunwind ext_cpython

script:
  - ccache -z
  - ninja -j4 pyston
  - ccache -s
  - ninja check-pyston
  - if [ ! -d "$HOME/llvm-install" ]; then ninja -j4 package_llvm; fi
  - if [ ! -d "$HOME/llvm-install" ]; then mv llvm-*.tar.gz ~/llvm-package/; fi

os:
  - linux
# - osx

notifications:
  irc:
    channels:
      - "chat.freenode.net#pyston"
    on_success: [change]

  webhooks:
    urls:
      - https://webhooks.gitter.im/e/7256425a36658faa8b9b
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
